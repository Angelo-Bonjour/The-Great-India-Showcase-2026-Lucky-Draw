
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grand Lucky Draw</title>

<!-- Canvas Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<!-- Papa Parse for robust CSV parsing (handles quotes/commas) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root {
    --bg: #002f61;
    --gift-base: #f8dc8a;       /* lighter golden */
    --gift-shade: #e8c759;      /* darker golden */
    --lid-base: #f8dc8a;        /* lid light gold */
    --lid-shade: #e6c45a;       /* lid darker */
    --ribbon: #d62a2a;          /* deep red */
    --ribbon-highlight: #ff7b7b;/* highlight for loops */
    --btn1: #ffd24d;            /* button gradient 1 */
    --btn2: #ffb600;            /* button gradient 2 */
    --btnText: #121212;
    --text: #ffffff;
    --shadow: rgba(0,0,0,0.35);
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg); color: var(--text); min-height: 100vh;
    display: flex; flex-direction: column; align-items: center; gap: 14px;
  }
  header { width: min(96vw, 1100px); margin-top: 14px; }
  h1 { margin: 0 0 6px; letter-spacing: 0.5px; }
  .sub { opacity: .9; font-size: .95rem; }

  /* Top bar: Start Draw, Refresh, and Menu icon on the right */
  .topbar { width: 100%; max-width: 1100px; display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 12px; }
  #controls { display: flex; flex-wrap: wrap; gap: 10px; }
  .menu-btn { justify-self: end; appearance: none; border: none; background: rgba(255,255,255,.16); color: #fff; width: 44px; height: 44px; border-radius: 10px; display: grid; place-items: center; box-shadow: 0 4px 14px rgba(0,0,0,.25); cursor: pointer; }
  .menu-btn:hover { filter: brightness(1.08); }

  /* Fancy Buttons */
  .btn {
    appearance: none; border: none; border-radius: 12px; padding: 12px 16px; font-weight: 800; letter-spacing: 0.2px;
    background: linear-gradient(180deg, var(--btn1), var(--btn2)); color: var(--btnText);
    box-shadow: 0 6px 0 rgba(0,0,0,.22), 0 12px 24px rgba(0,0,0,.25);
    transform: translateY(0); transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover { filter: brightness(1.05); }
  .btn:active { transform: translateY(2px); box-shadow: 0 4px 0 rgba(0,0,0,.22), 0 10px 20px rgba(0,0,0,.25); }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .btn.ghost { background: transparent; color: #fff; border: 2px solid rgba(255,255,255,.5); box-shadow: none; }

  /* Stage & Gift */
  .stage { width: min(92vw, 900px); display: grid; place-items: center; }
  .gift {
    width: min(92vw, 820px); height: min(70vh, 520px); position: relative;
    display: grid; place-items: center; perspective: 900px; margin-top: 4px;
  }

  /* Box base (no ribbons on base) */
  .box-base {
    position: absolute; inset: 140px 0 0 0; /* leaves space for closed lid area */
    margin: auto; width: 100%; height: calc(100% - 140px);
    background: linear-gradient(145deg, var(--gift-base) 0%, var(--gift-shade) 100%);
    border-radius: 14px; border: 4px solid #fff; overflow: hidden;
    box-shadow: 0 16px 40px var(--shadow), inset 0 0 0 2px rgba(255,255,255,.25);
    z-index: 1;
  }

  /* Lid wrapper ensures ribbon/bow move together */
  .lid-wrap { position:absolute; width:100%; left:0; right:0; top:0; height: 150px; pointer-events:none; z-index:5; }
  .lid {
    position: absolute; width: calc(100% + 16px); height: 120px; left: 50%; transform: translateX(-50%);
    top: 20px; border-radius: 12px; border: 4px solid #fff;
    background: linear-gradient(145deg, var(--lid-base) 0%, var(--lid-shade) 100%);
    box-shadow: 0 10px 20px var(--shadow);
    transform-origin: center bottom; /* for fly-off/return */
  }

  /* Improved bow with visible smooth loops */
  .ribbon-vertical { position:absolute; left:50%; top:0; transform:translateX(-50%); width:56px; height:100%; background: linear-gradient(90deg, var(--ribbon) 0%, #b31f1f 100%); }
  .bow { position:absolute; top:-8px; left:50%; transform:translateX(-50%); width:180px; height:86px; pointer-events:none; }
  /* left loop */
  .loopL, .loopR {
    position:absolute; width:86px; height:70px; border-radius:50% 50% 45% 45%;
    background: radial-gradient(circle at 35% 35%, var(--ribbon-highlight), var(--ribbon));
    box-shadow: inset 0 0 10px rgba(0,0,0,.25), 0 4px 8px rgba(0,0,0,.15);
  }
  .loopL { left:0; transform: rotate(-10deg); }
  .loopR { right:0; transform: rotate(10deg); }
  .knot {
    position:absolute; left:50%; top:26px; transform:translateX(-50%);
    width:38px; height:32px; border-radius:10px; background: linear-gradient(145deg, #ff5656, #a71616);
    box-shadow: inset 0 0 8px rgba(0,0,0,.25);
  }
  /* ribbon tails */
  .tailL, .tailR {
    position:absolute; top:58px; width:48px; height:26px; background: linear-gradient(145deg, var(--ribbon), #b31f1f);
    clip-path: polygon(0 0, 100% 0, 80% 100%, 0 100%);
  }
  .tailL { left:36px; transform: rotate(-12deg); }
  .tailR { right:36px; transform: rotate(12deg) scaleX(-1); }

  /* Lid animations */
  .lid-fly { animation: flyOff 1.1s ease-out forwards; }
  @keyframes flyOff {
    0% { transform: translate(-50%, 0) rotate(0); }
    60% { transform: translate(calc(-50% - 80px), -180px) rotate(-18deg); }
    100% { transform: translate(calc(-50% - 150px), -300px) rotate(-28deg); opacity: .95; }
  }
  .lid-return { animation: flyBack 0.9s ease-in forwards; }
  @keyframes flyBack {
    0% { transform: translate(calc(-50% - 150px), -300px) rotate(-28deg); opacity: .95; }
    100% { transform: translate(-50%, 0) rotate(0); opacity: 1; }
  }

  /* Entries grid */
  .box-content {
    position: absolute; inset: 160px 16px 16px 16px; /* well below lid */
    display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
    gap: 10px; align-content: start; overflow: hidden; scrollbar-width: thin; z-index: 2;
  }
  .entry {
    background: rgba(255,255,255,.9); border: 1px solid rgba(0,0,0,.08);
    padding: 10px; border-radius: 10px; text-align: center; font-size: .98rem;
    animation: blink 1.2s infinite; /* faster blink */
    transition: transform .12s ease, left .35s ease, top .35s ease;
    color: #111; font-weight: 600;
  }
  .entry .name { font-weight: 800; display: block; color: #000; }
  .entry .company { font-size: .85rem; opacity: .9; color: #333; }
  @keyframes blink { 0%,100% {opacity:1} 50% {opacity:.45} }

  /* Free-move mode during draw */
  .free .entry { position: absolute; width: 190px; }

  /* Overlays & Modals */
  .overlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.35); z-index: 100; backdrop-filter: blur(1px); }
  .modal { background: #fff; color:#111; width:min(92vw, 720px); border-radius: 14px; box-shadow: 0 24px 60px rgba(0,0,0,.45); position: relative; }
  .modal .head { padding: 14px 18px; border-bottom: 1px solid #eee; font-weight: 800; display:flex; align-items:center; justify-content:space-between; }
  .modal .body { padding: 16px 18px; max-height: 70vh; overflow:auto; }
  .modal .close { appearance:none; background:transparent; border:none; font-size: 20px; cursor:pointer; }

  /* Countdown text */
  #countOverlay .count { font-size: clamp(64px, 12vw, 140px); font-weight: 900; text-shadow: 0 6px 0 rgba(0,0,0,.3); color:#fff; }
  #countOverlay .label { margin-top: 6px; font-size: 1.1rem; opacity: .95; color:#fff; text-align:center; }

  /* Winner modal big text */
  #winnerName { font-size: clamp(28px, 5vw, 60px); font-weight: 900; line-height:1.2; text-align:center; }
  #winnerModal .body { display:grid; gap:12px; place-items:center; }

  /* Drawer (Slide-in from right) */
  .drawer-overlay { position: fixed; inset: 0; display:none; background: rgba(0,0,0,0.25); z-index: 200; }
  .drawer { position: fixed; right: 0; top: 0; width: min(90vw, 340px); height: 100vh; transform: translateX(100%);
    background: rgba(255,255,255,0.7); color: #000; backdrop-filter: blur(10px);
    box-shadow: -14px 0 40px rgba(0,0,0,.35); z-index: 210; transition: transform .25s ease; display:flex; flex-direction:column; }
  .drawer.open { transform: translateX(0); }
  .drawer .hd { display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; font-weight: 800; border-bottom: 1px solid rgba(0,0,0,.1); }
  .drawer .cnt { padding: 12px 16px; display: grid; gap: 12px; }
  .drawer .row { display:flex; align-items:center; justify-content:space-between; }
  .drawer label { font-weight: 700; }

  /* Lucky Ones modal */
  #luckyOverlay .modal { width: min(96vw, 820px); }
  .searchbar { display:flex; gap:8px; margin-bottom:10px; }
  .searchbar input { flex:1; padding:10px 12px; border:1px solid #ccc; border-radius:10px; font-size: 14px; }
  .lucky-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:10px; max-height: 52vh; overflow:auto; }
  .cand { border:1px solid #ddd; border-radius:10px; padding:10px; display:flex; align-items:center; justify-content:space-between; background:#fff; }
  .cand .meta { display:grid; }
  .cand .name { font-weight:800; }
  .cand .company { font-size:.9rem; opacity:.85; }
  .pick-btn { padding:8px 10px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }
  .pick-btn.sel { background:#0b7dda; color:#fff; }
  .pick-btn.n { background:#f1f1f1; }
  .lucky-selected { margin: 8px 0 12px; padding: 10px; border-radius: 10px; background: #fff; border: 1px solid #eee; }
  .lucky-selected strong { display:inline-block; margin-right:8px; }

</style>
</head>
<body>
  <header>
    <h1>Grand Lucky Draw</h1>
    <div class="sub">Google Sheet CSV ‚Üí Columns: <strong>Full Name</strong> and <strong>Name of Company</strong></div>
  </header>

  <!-- Top bar with main actions on left, menu on right -->
  <div class="topbar">
    <div id="controls">
      <button id="btnStart" class="btn">üé¨ Start Draw</button>
      <button id="btnRefresh" class="btn">üîÑ Refresh Participants</button>
    </div>
    <button id="btnMenu" class="menu-btn" title="Menu">‚ò∞</button>
  </div>

  <div class="stage">
    <div class="gift" aria-label="Gift Box">
      <div class="lid-wrap">
        <div class="lid" id="lid">
          <div class="ribbon-vertical"></div>
          <div class="bow" aria-hidden="true">
            <div class="loopL"></div>
            <div class="loopR"></div>
            <div class="knot"></div>
            <div class="tailL"></div>
            <div class="tailR"></div>
          </div>
        </div>
      </div>
      <div class="box-base" aria-hidden="true"></div>
      <div id="entries" class="box-content">Loading participants‚Ä¶</div>
    </div>
  </div>

  <!-- Count Down Overlay -->
  <div id="countOverlay" class="overlay">
    <div style="text-align:center;">
      <div class="count" id="countText"></div>
      <div class="label" id="phaseLabel"></div>
    </div>
  </div>

  <!-- Winner Modal (stays until ‚úï) -->
  <div id="winnerOverlay" class="overlay">
    <div id="winnerModal" class="modal">
      <div class="head">Winner <button class="close" id="closeWinner">‚úï</button></div>
      <div class="body">
        <div id="winnerName">Winner Name</div>
        <div id="winnerCompany" style="font-size:1.1rem; opacity:.85"></div>
      </div>
    </div>
  </div>

  <!-- Past Winners Modal -->
  <div id="winnersOverlay" class="overlay">
    <div id="winnersModal" class="modal">
      <div class="head">Past Winners <button class="close" id="closeWinners">‚úï</button></div>
      <div class="body">
        <ol id="winnersList"></ol>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:8px">
          <button id="btnReset" class="btn">‚ôªÔ∏è Reset Draw</button>
          <button id="btnExportWinners" class="btn ghost">‚¨áÔ∏è Download Winners CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lucky Ones Rigging Modal -->
  <div id="luckyOverlay" class="overlay">
    <div id="luckyModal" class="modal">
      <div class="head">Lucky Ones (Pick next up to 3 winners) <button class="close" id="closeLucky">‚úï</button></div>
      <div class="body">
        <div class="lucky-selected"><strong>Selected order:</strong> <span id="luckySelected"></span>
          <button id="btnClearRig" class="btn" style="margin-left:10px;">Make Random Again</button>
        </div>
        <div class="searchbar">
          <input id="luckySearch" placeholder="Search name or company..." />
          <button id="luckyRefresh" class="btn ghost">Refresh List</button>
        </div>
        <div id="luckyGrid" class="lucky-grid"></div>
      </div>
    </div>
  </div>

  <!-- Right Drawer (70% white blur) -->
  <div id="drawerMask" class="drawer-overlay"></div>
  <aside id="drawer" class="drawer" aria-label="Menu">
    <div class="hd">Menu <button id="closeDrawer" class="menu-btn" style="background:transparent;color:#000;width:auto;height:auto;padding:6px 10px;">‚úï</button></div>
    <div class="cnt">
      <div class="row"><label for="autoRefresh">Auto-Refresh (10s)</label><input type="checkbox" id="autoRefresh"></div>
      <button id="btnSound" class="btn" title="Use your own MP3s (drumroll.mp3 & pop.mp3)">üîä Enable Sound</button>
      <button id="btnWinners" class="btn ghost">üèÜ Past Winners</button>
      <button id="btnLucky" class="btn ghost">üçÄ Lucky Ones</button>
    </div>
  </aside>

  <!-- Local audio (user-provided). Place your files at /assets/drum.mp3 and /assets/pop.mp3 -->
  <audio id="drum" preload="auto" src="drumroll.mp3"></audio>
  <audio id="pop" preload="auto" src="pop.mp3"></audio>

<script>
(function(){
  // ---- Config ----
  const DEFAULT_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9EzQVA4kCkKxyzpQ2S61wrHce8ohaH7v_QvgPzfLqNMkghG3O-_JGYQBVcUmE0-Y-vsKio3pnTeh5/pub?output=csv";
  const DRAW_COUNTDOWN_SEC = 3;
  const DRAW_PHASE_MS = 5000;
  const AUTO_REFRESH_MS = 10000;
  const BLINK_MS = 1200; // matches CSS blink duration

  // ---- State ----
  let participants = []; // ["Full Name (Company)", ...]
  let activePool = [];
  let winners = [];
  let luckyQueue = []; // ordered 0..2

  let autoTimer = null; let drawing = false; let moveTimer = null; let idleShuffleTimer = null;

  // ---- Elements ----
  const entriesEl = document.getElementById('entries');
  const lidEl = document.getElementById('lid');
  const countOverlay = document.getElementById('countOverlay');
  const countText = document.getElementById('countText');
  const phaseLabel = document.getElementById('phaseLabel');

  const btnRefresh = document.getElementById('btnRefresh');
  const btnStart = document.getElementById('btnStart');
  const btnReset = document.getElementById('btnReset');
  const chkAuto = document.getElementById('autoRefresh');
  const btnSound = document.getElementById('btnSound');
  const btnWinners = document.getElementById('btnWinners');
  const btnLucky = document.getElementById('btnLucky');

  const btnMenu = document.getElementById('btnMenu');
  const drawer = document.getElementById('drawer');
  const drawerMask = document.getElementById('drawerMask');
  const closeDrawer = document.getElementById('closeDrawer');

  const drum = document.getElementById('drum'); const pop = document.getElementById('pop');
  drum.volume = 0.9; pop.volume = 0.7;

  // Winner modal
  const winnerOverlay = document.getElementById('winnerOverlay');
  const closeWinner = document.getElementById('closeWinner');
  const winnerNameEl = document.getElementById('winnerName');
  const winnerCompanyEl = document.getElementById('winnerCompany');

  // Past winners modal
  const winnersOverlay = document.getElementById('winnersOverlay');
  const closeWinners = document.getElementById('closeWinners');
  const winnersListEl = document.getElementById('winnersList');

  // Lucky Ones modal
  const luckyOverlay = document.getElementById('luckyOverlay');
  const luckyModal = document.getElementById('luckyModal');
  const closeLucky = document.getElementById('closeLucky');
  const luckyGrid = document.getElementById('luckyGrid');
  const luckySelected = document.getElementById('luckySelected');
  const luckySearch = document.getElementById('luckySearch');
  const luckyRefresh = document.getElementById('luckyRefresh');
  const btnClearRig = document.getElementById('btnClearRig');

  // ---- Utils ----
  function getCsvUrl(){
    const urlParam = new URLSearchParams(location.search).get('csv');
    let url = urlParam ? decodeURIComponent(urlParam) : DEFAULT_SHEET_CSV;
    const marker = 'output=csv'; const idx = url.indexOf(marker); if (idx !== -1) url = url.slice(0, idx + marker.length);
    return url;
  }

  function disableControls(disabled){ [btnStart, btnRefresh, btnReset, chkAuto, btnSound, btnWinners, btnLucky].forEach(el => { if (el) el.disabled = disabled; }); }

  function renderEntries(){
    if (!activePool.length){ entriesEl.textContent = 'No participants available.'; return; }
    const html = activePool.map(p => {
      const m = p.match(/^(.*) \((.*)\)$/); const name = m ? m[1] : p; const company = m ? m[2] : '';
      return `<div class="entry"><span class="name">${escapeHtml(name)}</span><span class="company">${escapeHtml(company)}</span></div>`;
    }).join(''); entriesEl.innerHTML = html;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // ---- CSV Fetch & Parse ----
  async function refreshParticipants(){
    try {
      const url = getCsvUrl(); const res = await fetch(url, { cache: 'no-store' }); if (!res.ok) throw new Error('Network error: ' + res.status);
      const csvText = await res.text(); const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true }); if (parsed.errors && parsed.errors.length){ console.warn(parsed.errors); }
      const rows = parsed.data; const toKey = s => String(s||'').trim().toLowerCase();
      const mapped = rows.map(r => { const o={}; Object.keys(r).forEach(k=>o[toKey(k)]=r[k]); const full=(o['full name']||o['fullname']||o['name']||'').toString().trim(); const comp=(o['name of company']||o['company']||'').toString().trim(); return { full, comp }; }).filter(x=>x.full && x.comp);
      participants = mapped.map(x => `${x.full} (${x.comp})`);
      // unique
      const seen=new Set(); participants = participants.filter(p => (seen.has(p)?false:(seen.add(p),true)));
      // active pool excludes winners
      activePool = participants.filter(p => !winners.includes(p));
      // sanitize luckyQueue to only include names still in pool
      luckyQueue = luckyQueue.filter(p => activePool.includes(p)).slice(0,3);
      renderEntries(); startIdleShuffle();
    } catch (err){ console.error(err); entriesEl.textContent = 'Unable to load participants. Ensure CSV is published and columns are correct.'; }
  }

  // ---- Idle Shuffle on Blink ----
  function startIdleShuffle(){ stopIdleShuffle(); idleShuffleTimer = setInterval(()=>{ if (drawing) return; if (activePool.length < 2) return; for (let i = activePool.length - 1; i > 0; i--) { if (Math.random() < 0.25){ const j = Math.floor(Math.random() * (i + 1)); [activePool[i], activePool[j]] = [activePool[j], activePool[i]]; } } renderEntries(); }, BLINK_MS); }
  function stopIdleShuffle(){ if (idleShuffleTimer) { clearInterval(idleShuffleTimer); idleShuffleTimer = null; } }

  // ---- Auto refresh ----
  function toggleAuto(){ if (chkAuto.checked){ autoTimer = setInterval(refreshParticipants, AUTO_REFRESH_MS); } else { clearInterval(autoTimer); autoTimer = null; } }

  // ---- Countdown ----
  function countdown(sec){ countOverlay.style.display = 'grid'; phaseLabel.textContent = 'Get Ready‚Ä¶'; return new Promise(resolve => { let cur = sec; countText.textContent = cur; const timer = setInterval(()=>{ cur -= 1; countText.textContent = cur > 0 ? cur : 'Go!'; if (cur <= 0){ clearInterval(timer); setTimeout(resolve, 600); } }, 1000); }); }

  // ---- Free movement during draw ----
  function startFreeMove(){ stopIdleShuffle(); entriesEl.classList.add('free'); const items = Array.from(entriesEl.children); randomizePositions(items); moveTimer = setInterval(()=>{ randomizePositions(items); }, 380); }
  function randomizePositions(items){ const b = entriesEl.getBoundingClientRect(); items.forEach(el => { const r = el.getBoundingClientRect(); const w = r.width || 190; const h = r.height || 68; const pad=6; const maxX = Math.max(0, b.width - w - pad); const maxY = Math.max(0, b.height - h - pad); const x = Math.floor(Math.random()*maxX) + pad/2; const y = Math.floor(Math.random()*maxY) + pad/2; const rot = (Math.random()*10 - 5); const scale = 1 + (Math.random()*0.08); el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.transform = `rotate(${rot}deg) scale(${scale})`; }); }
  function stopFreeMove(){ clearInterval(moveTimer); moveTimer = null; entriesEl.classList.remove('free'); Array.from(entriesEl.children).forEach(el => { el.style.left=''; el.style.top=''; el.style.transform='none'; }); startIdleShuffle(); }

  // ---- Draw logic ----
  async function startDraw(){ if (drawing) return; if (!activePool.length){ alert('No participants left!'); return; } drawing = true; disableControls(true);
    await countdown(DRAW_COUNTDOWN_SEC);
    // Open the lid AFTER countdown
    lidEl.classList.remove('lid-fly','lid-return'); void lidEl.offsetWidth; lidEl.classList.add('lid-fly');
    // Start drum roll (local file)
    try { drum.currentTime = 0; await drum.play(); } catch(e) { console.warn('Drum play blocked or file missing:', e); }
    phaseLabel.textContent = 'Drawing‚Ä¶'; countText.textContent = '';
    // Free move
    startFreeMove();
    await new Promise(r => setTimeout(r, DRAW_PHASE_MS));
    stopFreeMove();
    // Pick winner: Lucky Ones override if available
    let winner = null;
    if (luckyQueue.length){
      const idx = luckyQueue.findIndex(p => activePool.includes(p));
      if (idx !== -1){ winner = luckyQueue[idx]; luckyQueue.splice(idx,1); }
    }
    if (!winner){ winner = activePool[Math.floor(Math.random()*activePool.length)]; }
    winners.push(winner); activePool = activePool.filter(p => p !== winner);
    // Confetti + pop sound
    burstConfetti(); try { pop.currentTime = 0; await pop.play(); } catch(e) { console.warn('Pop play blocked or file missing:', e); }
    // Show winner modal
    const m = winner.match(/^(.*) \((.*)\)$/); winnerNameEl.textContent = m ? m[1] : winner; winnerCompanyEl.textContent = m ? m[2] : '';
    winnerOverlay.style.display = 'grid'; countOverlay.style.display = 'none';
    renderEntries(); renderWinners(); updateLuckySelected();
    disableControls(false); drawing = false;
  }

  function burstConfetti(){ const end = Date.now() + 600; (function frame(){ confetti({ particleCount: 110, spread: 75, startVelocity: 58, origin: { y: 0.7 } }); if (Date.now() < end) requestAnimationFrame(frame); })(); confetti({ particleCount: 200, angle: 60, spread: 60, origin: { x: 0 }, zIndex: 200 }); confetti({ particleCount: 200, angle: 120, spread: 60, origin: { x: 1 }, zIndex: 200 }); }

  function renderWinners(){ winnersListEl.innerHTML = winners.map(w => `<li>${escapeHtml(w)}</li>`).join(''); }

  function resetDraw(){ winners = []; activePool = participants.slice(); renderWinners(); renderEntries(); lidEl.classList.remove('lid-fly','lid-return'); luckyQueue = []; updateLuckySelected(); }

  async function primeAudio(){ try { drum.volume = 0; await drum.play(); drum.pause(); drum.currentTime = 0; drum.volume = 0.9; pop.volume = 0; await pop.play(); pop.pause(); pop.currentTime = 0; pop.volume = 0.7; alert('Sound primed. Ensure assets/drum.mp3 & assets/pop.mp3 exist.'); } catch(e){ alert('Autoplay blocked OR MP3s missing. Sounds will play after interactions when available.'); } }

  function downloadWinnersCSV(){ if (!winners.length){ alert('No winners yet.'); return; } const rows = [['Full Name', 'Name of Company']].concat(winners.map(w => { const m = w.match(/^(.*) \((.*)\)$/); return [m?m[1]:w, m?m[2]:'' ]; })); const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n'); const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'past-winners.csv'; a.click(); URL.revokeObjectURL(url); }

  // ---- Drawer ----
  function openDrawer(){ drawerMask.style.display='block'; drawer.classList.add('open'); }
  function closeDrawerFn(){ drawerMask.style.display='none'; drawer.classList.remove('open'); }

  // ---- Lucky Ones rendering ----
  function renderLuckyList(){
    const q = (luckySearch.value||'').toLowerCase();
    const items = activePool.filter(p => p.toLowerCase().includes(q));
    luckyGrid.innerHTML = items.map(p => {
      const m = p.match(/^(.*) \((.*)\)$/); const name = m?m[1]:p; const comp=m?m[2]:''; const selected = luckyQueue.includes(p);
      return `<div class="cand"><div class="meta"><div class="name">${escapeHtml(name)}</div><div class="company">${escapeHtml(comp)}</div></div><button class="pick-btn ${selected?'sel':'n'}" data-id="${escapeHtml(p)}">${selected?'Selected':'Pick'}</button></div>`;
    }).join('');
    // Bind pick buttons
    luckyGrid.querySelectorAll('.pick-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-id');
        if (luckyQueue.includes(id)){
          luckyQueue = luckyQueue.filter(x => x !== id);
        } else {
          if (luckyQueue.length >= 3){ alert('You can only queue up to 3 Lucky Ones.'); return; }
          luckyQueue.push(id);
        }
        updateLuckySelected(); renderLuckyList();
      });
    });
  }
  function updateLuckySelected(){ luckySelected.textContent = luckyQueue.length ? luckyQueue.map(x=>x.replace(/ \(.+\)$/,'')).join(' ‚Üí ') : 'None'; }

  function clearRig(){ luckyQueue = []; updateLuckySelected(); renderLuckyList(); }

  // ---- Lid return on close winner ----
  function lidReturn(){ lidEl.classList.remove('lid-fly','lid-return'); void lidEl.offsetWidth; lidEl.classList.add('lid-return'); }

  // ---- Wire up ----
  btnRefresh.addEventListener('click', refreshParticipants);
  btnStart.addEventListener('click', startDraw);
  if (btnReset) btnReset.addEventListener('click', () => { resetDraw(); renderWinners(); });
  chkAuto.addEventListener('change', toggleAuto);
  btnSound.addEventListener('click', primeAudio);
  btnWinners.addEventListener('click', () => { winnersOverlay.style.display = 'grid'; closeDrawerFn(); });
  btnMenu.addEventListener('click', openDrawer); closeDrawer.addEventListener('click', closeDrawerFn); drawerMask.addEventListener('click', closeDrawerFn);

  btnLucky.addEventListener('click', () => { luckyOverlay.style.display='grid'; renderLuckyList(); updateLuckySelected(); closeDrawerFn(); });
  luckySearch.addEventListener('input', renderLuckyList); luckyRefresh.addEventListener('click', renderLuckyList); btnClearRig.addEventListener('click', clearRig);

  closeWinner.addEventListener('click', () => { winnerOverlay.style.display = 'none'; lidReturn(); });
  closeWinners.addEventListener('click', () => winnersOverlay.style.display = 'none');
  closeLucky.addEventListener('click', () => { luckyOverlay.style.display='none'; });

  winnersOverlay.addEventListener('click', (e)=>{ if (e.target === winnersOverlay) winnersOverlay.style.display = 'none'; });
  winnerOverlay.addEventListener('click', (e)=>{ if (e.target === winnerOverlay) { winnerOverlay.style.display = 'none'; lidReturn(); }});
  luckyOverlay.addEventListener('click', (e)=>{ if (e.target === luckyOverlay) luckyOverlay.style.display = 'none'; });

  // Initial load
  refreshParticipants();
})();
</script>
</body>
</html>
