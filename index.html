
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grand Lucky Draw</title>

<!-- Canvas Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<!-- Papa Parse for robust CSV parsing (handles quotes/commas) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root {
    --bg: #002f61;
    --gift-base: #0a3e80;
    --gift-shade: #08356d;
    --ribbon: #d62828; /* deep red */
    --ribbon-dark: #a71e1e;
    --gold: #ffcc00;
    --text: #ffffff;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg); color: var(--text); min-height: 100vh;
    display: flex; flex-direction: column; align-items: center; gap: 16px;
  }
  header { text-align: center; margin-top: 18px; }
  h1 { margin: 0 0 8px; letter-spacing: 0.5px; }
  .sub { opacity: .85; font-size: .95rem; }

  /* Controls */
  #controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
  button, .chip {
    cursor: pointer; border: none; border-radius: 8px; padding: 10px 14px; font-weight: 600;
    background: var(--gold); color: #111; box-shadow: 0 2px 0 rgba(0,0,0,.15);
  }
  button:disabled { opacity: .6; cursor: not-allowed; }
  .chip { background: rgba(255,255,255,.15); color: #fff; border: 1px solid rgba(255,255,255,.25); }
  .chip input { vertical-align: middle; margin-right: 6px; }

  /* Gift Box */
  .stage { width: min(92vw, 820px); display: grid; place-items: center; }
  .gift {
    width: min(90vw, 720px); height: min(65vh, 440px); position: relative;
    display: grid; place-items: center; perspective: 900px; margin-top: 8px;
  }
  /* Box base */
  .box-base {
    position: absolute; inset: 60px 0 0 0; /* leave space for lid to sit above */
    margin: auto; width: 100%; height: calc(100% - 60px);
    background: linear-gradient(145deg, var(--gift-base) 0%, var(--gift-shade) 100%);
    border-radius: 14px; border: 4px solid #fff; overflow: hidden;
    box-shadow: 0 16px 40px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.15);
  }
  /* Horizontal ribbon across base */
  .box-base::before {
    content: ""; position: absolute; left: 0; right: 0; top: 40%; height: 46px;
    background: linear-gradient(180deg, var(--ribbon) 0%, var(--ribbon-dark) 100%);
  }
  /* Vertical ribbon across base */
  .box-base::after {
    content: ""; position: absolute; top: 0; bottom: 0; left: 50%; width: 46px; transform: translateX(-50%);
    background: linear-gradient(90deg, var(--ribbon) 0%, var(--ribbon-dark) 100%);
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.15);
  }

  /* Lid */
  .lid {
    position: absolute; width: calc(100% + 16px); height: 80px; left: 50%; transform: translateX(-50%);
    top: 20px; border-radius: 12px; border: 4px solid #fff; z-index: 5;
    background: linear-gradient(145deg, #0d4c9a 0%, #0a3e80 100%);
    box-shadow: 0 10px 20px rgba(0,0,0,.35);
    transform-origin: center bottom;
  }
  /* Lid ribbon strip */
  .lid::after {
    content: ""; position: absolute; left: 50%; top: 0; width: 54px; height: 100%; transform: translateX(-50%);
    background: linear-gradient(90deg, var(--ribbon) 0%, var(--ribbon-dark) 100%);
  }
  /* Bow on top */
  .bow {
    position: absolute; top: -12px; left: 50%; transform: translateX(-50%); z-index: 6;
    width: 130px; height: 60px;
  }
  .bow .loop {
    position: absolute; width: 60px; height: 50px; border-radius: 50% 50% 45% 45%;
    background: radial-gradient(circle at 30% 30%, #ff6b6b, var(--ribbon-dark));
    box-shadow: inset 0 0 8px rgba(0,0,0,.25);
  }
  .bow .loop.left { left: 0; transform: rotate(-12deg); }
  .bow .loop.right { right: 0; transform: rotate(12deg); }
  .bow .knot {
    position: absolute; left: 50%; top: 16px; transform: translateX(-50%);
    width: 34px; height: 28px; border-radius: 10px;
    background: linear-gradient(145deg, #ff4b4b, var(--ribbon-dark));
    box-shadow: inset 0 0 6px rgba(0,0,0,.25);
  }

  /* Lid animation */
  .lid-fly {
    animation: flyOff 1.1s ease-out forwards;
  }
  @keyframes flyOff {
    0% { transform: translate(-50%, 0) rotate(0); }
    60% { transform: translate(calc(-50% - 80px), -140px) rotate(-18deg); }
    100% { transform: translate(calc(-50% - 120px), -220px) rotate(-28deg); opacity: .9; }
  }

  /* Entries grid */
  .box-content {
    position: absolute; inset: 80px 16px 16px 16px; /* safely below lid area */
    display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 10px; align-content: start; overflow: auto; scrollbar-width: thin;
  }
  .entry {
    background: rgba(255,255,255,.14); border: 1px solid rgba(255,255,255,.25);
    padding: 10px; border-radius: 10px; text-align: center; font-size: .95rem;
    animation: slowBlink 3s infinite; transition: transform .12s ease;
  }
  .entry .name { font-weight: 700; display: block; }
  .entry .company { font-size: .85rem; opacity: .9; }
  @keyframes slowBlink { 0%,100% {opacity:1} 50% {opacity:.55} }

  /* Countdown overlay */
  #overlay {
    position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.35);
    z-index: 50; text-align: center; backdrop-filter: blur(1px);
  }
  #overlay .count { font-size: clamp(64px, 12vw, 140px); font-weight: 800; text-shadow: 0 6px 0 rgba(0,0,0,.3); }
  #overlay .label { margin-top: 6px; font-size: 1.1rem; opacity: .9; }

  /* Winners */
  #winners { width: min(92vw, 820px); background: rgba(255,255,255,.1); padding: 14px; border-radius: 12px; }
  #winners h2 { margin: 0 0 10px; }
  #winnerList { margin: 6px 0 0; padding-left: 18px; }
  #status { min-height: 20px; opacity: .9; font-size: .9rem; }

  .note { font-size: .86rem; opacity: .85; }
</style>
</head>
<body>
  <header>
    <h1>Grand Lucky Draw</h1>
    <div class="sub">Fetches participants from your Google Sheet CSV (Full Name + Name of Company)</div>
  </header>

  <div id="controls">
    <button id="btnRefresh">Refresh Participant List</button>
    <label class="chip"><input type="checkbox" id="autoRefresh"> Auto-Refresh (10s)</label>
    <button id="btnStart">Start Draw</button>
  </div>

  <div class="stage">
    <div class="gift" aria-label="Gift Box">
      <div class="lid" id="lid"></div>
      <div class="bow" aria-hidden="true">
        <div class="loop left"></div>
        <div class="loop right"></div>
        <div class="knot"></div>
      </div>
      <div class="box-base" aria-hidden="true"></div>
      <div id="entries" class="box-content">Loading participantsâ€¦</div>
    </div>
  </div>

  <section id="winners">
    <div id="status"></div>
    <h2>Past Winners</h2>
    <ul id="winnerList"></ul>
    <button id="btnReset">Reset Draw</button>
    <div class="note">Tip: You can also pass a CSV URL by appending <code>?csv=ENCODED_URL</code> to the page URL.</div>
  </section>

  <!-- Overlay for countdown / drawing state -->
  <div id="overlay">
    <div>
      <div class="count" id="countText"></div>
      <div class="label" id="phaseLabel"></div>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="drum" preload="auto" src="https://www.soundjay.com/human/sounds/drum-roll-01.mp3"></audio>
  <audio id="tada" preload="auto" src="https://www.soundjay.com/human/sounds/applause-01.mp3"></audio>

<script>
(function(){
  // ---- Config ----
  const DEFAULT_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9EzQVA4kCkKxyzpQ2S61wrHce8ohaH7v_QvgPzfLqNMkghG3O-_JGYQBVcUmE0-Y-vsKio3pnTeh5/pub?output=csv";
  const DRAW_COUNTDOWN_SEC = 3;
  const DRAW_PHASE_MS = 5000;
  const AUTO_REFRESH_MS = 10000;

  // ---- State ----
  let participants = []; // ["Full Name (Company)", ...]
  let activePool = [];
  let winners = [];
  let autoTimer = null;
  let drawing = false;
  let danceTimer = null;

  // ---- Elements ----
  const entriesEl = document.getElementById('entries');
  const lidEl = document.getElementById('lid');
  const overlayEl = document.getElementById('overlay');
  const countText = document.getElementById('countText');
  const phaseLabel = document.getElementById('phaseLabel');
  const statusEl = document.getElementById('status');

  const btnRefresh = document.getElementById('btnRefresh');
  const btnStart = document.getElementById('btnStart');
  const btnReset = document.getElementById('btnReset');
  const chkAuto = document.getElementById('autoRefresh');

  // ---- Utils ----
  function getCsvUrl(){
    const urlParam = new URLSearchParams(location.search).get('csv');
    let url = urlParam ? decodeURIComponent(urlParam) : DEFAULT_SHEET_CSV;
    // sanitize accidental paste like "...output=csvThe names..."
    const marker = 'output=csv';
    const idx = url.indexOf(marker);
    if (idx !== -1) url = url.slice(0, idx + marker.length);
    return url;
  }

  function setStatus(msg, isError=false){
    statusEl.textContent = msg || '';
    statusEl.style.color = isError ? '#ffd2d2' : '#ffffff';
  }

  function disableControls(disabled){
    btnStart.disabled = disabled; btnRefresh.disabled = disabled; btnReset.disabled = disabled; chkAuto.disabled = disabled;
  }

  function renderEntries(){
    if (!activePool.length){ entriesEl.textContent = 'No participants available.'; return; }
    const html = activePool.map(p => {
      const m = p.match(/^(.*) \((.*)\)$/); // Full Name (Company)
      const name = m ? m[1] : p; const company = m ? m[2] : '';
      return `<div class="entry"><span class="name">${escapeHtml(name)}</span><span class="company">${escapeHtml(company)}</span></div>`;
    }).join('');
    entriesEl.innerHTML = html;
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // ---- CSV Fetch & Parse ----
  async function refreshParticipants(){
    try {
      setStatus('Fetching participantsâ€¦');
      const url = getCsvUrl();
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Network error: ' + res.status);
      const csvText = await res.text();
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      if (parsed.errors && parsed.errors.length){ console.warn(parsed.errors); }

      const rows = parsed.data;
      // Expect columns: "Full Name" and "Name of Company" (case-insensitive)
      const toKey = s => String(s||'').trim().toLowerCase();
      const mapped = rows.map(r => {
        const o = {}; Object.keys(r).forEach(k => { o[toKey(k)] = r[k]; });
        const full = (o['full name'] || o['fullname'] || o['name'] || '').toString().trim();
        const comp = (o['name of company'] || o['company'] || '').toString().trim();
        return { full, comp };
      }).filter(x => x.full && x.comp);

      participants = mapped.map(x => `${x.full} (${x.comp})`);
      // De-duplicate while preserving order
      const seen = new Set();
      participants = participants.filter(p => (seen.has(p) ? false : (seen.add(p), true)));

      activePool = participants.filter(p => !winners.includes(p));
      renderEntries();
      setStatus(`Loaded ${participants.length} participants. Active pool: ${activePool.length}.`);
    } catch (err){
      console.error(err);
      setStatus('Failed to fetch/parse CSV. Make sure the sheet is "Published to the web" as CSV and that columns are named "Full Name" and "Name of Company".', true);
      entriesEl.textContent = 'Unable to load participants.';
    }
  }

  // ---- Auto refresh ----
  function toggleAuto(){
    if (chkAuto.checked){
      autoTimer = setInterval(refreshParticipants, AUTO_REFRESH_MS);
    } else {
      clearInterval(autoTimer); autoTimer = null;
    }
  }

  // ---- Countdown ----
  function countdown(sec){
    overlayEl.style.display = 'grid';
    phaseLabel.textContent = 'Get Readyâ€¦';
    return new Promise(resolve => {
      let cur = sec;
      countText.textContent = cur;
      const timer = setInterval(()=>{
        cur -= 1; countText.textContent = cur > 0 ? cur : 'Go!';
        if (cur <= 0){ clearInterval(timer); setTimeout(resolve, 600); }
      }, 1000);
    });
  }

  // ---- Dance animation during draw ----
  function startDance(){
    const items = Array.from(document.querySelectorAll('.entry'));
    items.forEach(el => el.style.animationPlayState = 'paused'); // pause blinking
    let tick = 0;
    danceTimer = setInterval(()=>{
      tick++;
      items.forEach(el => {
        const dx = (Math.random()*12 - 6); // -6..6px
        const dy = (Math.random()*12 - 6);
        const rot = (Math.random()*6 - 3);
        const scale = 1 + (Math.random()*0.06);
        el.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg) scale(${scale})`;
      });
    }, 140);
  }
  function stopDance(){
    clearInterval(danceTimer); danceTimer = null;
    document.querySelectorAll('.entry').forEach(el => { el.style.transform = 'none'; el.style.animationPlayState = 'running'; });
  }

  // ---- Draw logic ----
  async function startDraw(){
    if (drawing) return; if (!activePool.length){ alert('No participants left!'); return; }
    drawing = true; disableControls(true);

    // Lid fly off
    lidEl.classList.remove('lid-fly'); void lidEl.offsetWidth; // reflow
    lidEl.classList.add('lid-fly');

    await countdown(DRAW_COUNTDOWN_SEC);

    // Start drum roll and dance
    try { document.getElementById('drum').currentTime = 0; document.getElementById('drum').play(); } catch(e){}
    phaseLabel.textContent = 'Drawingâ€¦'; countText.textContent = '';
    startDance();

    await new Promise(r => setTimeout(r, DRAW_PHASE_MS));

    stopDance();

    // Pick winner (unique)
    const winner = activePool[Math.floor(Math.random()*activePool.length)];
    winners.push(winner);
    activePool = activePool.filter(p => p !== winner);

    // Confetti blast (multi-pop)
    burstConfetti();
    try { const tada = document.getElementById('tada'); tada.currentTime = 0; tada.play(); } catch(e){}

    overlayEl.style.display = 'grid';
    countText.textContent = 'ðŸŽ‰';
    phaseLabel.textContent = 'Winner!\n' + winner;
    setTimeout(()=> overlayEl.style.display = 'none', 2200);

    renderEntries();
    renderWinners();

    setStatus(`Winner: ${winner}. Remaining in pool: ${activePool.length}.`);
    disableControls(false); drawing = false;
  }

  function burstConfetti(){
    const end = Date.now() + 600;
    (function frame(){
      confetti({ particleCount: 90, spread: 70, startVelocity: 50, origin: { y: 0.7 } });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
    // Side cannons
    confetti({ particleCount: 160, angle: 60, spread: 55, origin: { x: 0 }, zIndex: 200 });
    confetti({ particleCount: 160, angle: 120, spread: 55, origin: { x: 1 }, zIndex: 200 });
  }

  function renderWinners(){
    const ul = document.getElementById('winnerList');
    ul.innerHTML = winners.map(w => `<li>${escapeHtml(w)}</li>`).join('');
  }

  function resetDraw(){
    winners = []; activePool = participants.slice(); renderWinners(); renderEntries(); setStatus('Reset complete.');
    // Bring lid back by removing class (it starts closed visually)
    lidEl.classList.remove('lid-fly');
  }

  // ---- Wire up ----
  btnRefresh.addEventListener('click', refreshParticipants);
  btnStart.addEventListener('click', startDraw);
  btnReset.addEventListener('click', resetDraw);
  chkAuto.addEventListener('change', toggleAuto);

  // Initial load
  refreshParticipants();
})();
</script>
</body>
</html>
