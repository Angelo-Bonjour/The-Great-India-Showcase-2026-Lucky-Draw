
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grand Lucky Draw</title>

<!-- Canvas Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<!-- Papa Parse for robust CSV parsing (handles quotes/commas) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root {
    --bg: #002f61;
    --gift-base: #f8dc8a;       /* lighter golden */
    --gift-shade: #e8c759;      /* darker golden */
    --lid-base: #f8dc8a;        /* lid light gold */
    --lid-shade: #e6c45a;       /* lid darker */
    --ribbon: #d62828;          /* deep red for bow only */
    --ribbon-dark: #a71e1e;
    --btn1: #ffd24d;            /* button gradient 1 */
    --btn2: #ffb600;            /* button gradient 2 */
    --btnText: #121212;
    --text: #ffffff;
    --shadow: rgba(0,0,0,0.35);
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg); color: var(--text); min-height: 100vh;
    display: flex; flex-direction: column; align-items: center; gap: 16px;
  }
  header { text-align: center; margin-top: 18px; }
  h1 { margin: 0 0 8px; letter-spacing: 0.5px; }
  .sub { opacity: .9; font-size: .95rem; }

  /* Fancy Buttons */
  #controls { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
  .btn {
    appearance: none; border: none; border-radius: 12px; padding: 12px 16px; font-weight: 800; letter-spacing: 0.2px;
    background: linear-gradient(180deg, var(--btn1), var(--btn2)); color: var(--btnText);
    box-shadow: 0 6px 0 rgba(0,0,0,.22), 0 12px 24px rgba(0,0,0,.25);
    transform: translateY(0); transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover { filter: brightness(1.05); }
  .btn:active { transform: translateY(2px); box-shadow: 0 4px 0 rgba(0,0,0,.22), 0 10px 20px rgba(0,0,0,.25); }
  .btn:disabled { opacity:.6; cursor:not-allowed; }
  .btn.outline { background: transparent; color: #fff; border: 2px solid rgba(255,255,255,.5); box-shadow: none; }

  /* Stage & Gift */
  .stage { width: min(92vw, 900px); display: grid; place-items: center; }
  .gift {
    width: min(92vw, 820px); height: min(70vh, 520px); position: relative;
    display: grid; place-items: center; perspective: 900px; margin-top: 8px;
  }

  /* Box base (no ribbons on base) */
  .box-base {
    position: absolute; inset: 140px 0 0 0; /* leaves space for closed lid area */
    margin: auto; width: 100%; height: calc(100% - 140px);
    background: linear-gradient(145deg, var(--gift-base) 0%, var(--gift-shade) 100%);
    border-radius: 14px; border: 4px solid #fff; overflow: hidden;
    box-shadow: 0 16px 40px var(--shadow), inset 0 0 0 2px rgba(255,255,255,.25);
    z-index: 1;
  }

  /* Lid */
  .lid-wrap { position:absolute; width:100%; left:0; right:0; top:0; height: 150px; pointer-events:none; z-index:5; }
  .lid {
    position: absolute; width: calc(100% + 16px); height: 120px; left: 50%; transform: translateX(-50%);
    top: 20px; border-radius: 12px; border: 4px solid #fff;
    background: linear-gradient(145deg, var(--lid-base) 0%, var(--lid-shade) 100%);
    box-shadow: 0 10px 20px var(--shadow);
    transform-origin: center bottom;
  }
  .lid .ribbon-vertical { position:absolute; left:50%; top:0; transform:translateX(-50%); width:56px; height:100%; background: linear-gradient(90deg, var(--ribbon) 0%, var(--ribbon-dark) 100%); }

  /* Bow attached to lid */
  .bow { position:absolute; top:-6px; left:50%; transform:translateX(-50%); width:160px; height:72px; pointer-events:none; }
  .bow .loop { position:absolute; width:76px; height:58px; border-radius:50% 50% 45% 45%; background: radial-gradient(circle at 30% 30%, #ff6b6b, var(--ribbon-dark)); box-shadow: inset 0 0 8px rgba(0,0,0,.25); }
  .bow .loop.left{ left:0; transform:rotate(-12deg);} .bow .loop.right{ right:0; transform:rotate(12deg);} 
  .bow .knot { position:absolute; left:50%; top:20px; transform:translateX(-50%); width:36px; height:30px; border-radius:10px; background: linear-gradient(145deg, #ff4b4b, var(--ribbon-dark)); box-shadow: inset 0 0 6px rgba(0,0,0,.25); }

  /* Lid animation AFTER countdown */
  .lid-fly { animation: flyOff 1.1s ease-out forwards; }
  @keyframes flyOff {
    0% { transform: translate(-50%, 0) rotate(0); }
    60% { transform: translate(calc(-50% - 80px), -180px) rotate(-18deg); }
    100% { transform: translate(calc(-50% - 150px), -300px) rotate(-28deg); opacity: .95; }
  }

  /* Entries grid */
  .box-content {
    position: absolute; inset: 160px 16px 16px 16px; /* well below lid */
    display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
    gap: 10px; align-content: start; overflow: hidden; scrollbar-width: thin; z-index: 2;
  }
  .entry {
    background: rgba(255,255,255,.75); border: 1px solid rgba(0,0,0,.1);
    padding: 10px; border-radius: 10px; text-align: center; font-size: .98rem;
    animation: blink 1.2s infinite; /* faster blink */
    transition: transform .12s ease, left .35s ease, top .35s ease;
    color: #111; font-weight: 600;
  }
  .entry .name { font-weight: 800; display: block; color: #000; }
  .entry .company { font-size: .85rem; opacity: .9; color: #333; }
  @keyframes blink { 0%,100% {opacity:1} 50% {opacity:.45} }

  /* Free-move mode during draw */
  .free .entry { position: absolute; width: 190px; }

  /* Overlays & Modals */
  .overlay { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.35); z-index: 100; backdrop-filter: blur(1px); }
  .modal { background: #fff; color:#111; width:min(92vw, 720px); border-radius: 14px; box-shadow: 0 24px 60px rgba(0,0,0,.45); position: relative; }
  .modal .head { padding: 14px 18px; border-bottom: 1px solid #eee; font-weight: 800; display:flex; align-items:center; justify-content:space-between; }
  .modal .body { padding: 16px 18px; max-height: 70vh; overflow:auto; }
  .modal .close { appearance:none; background:transparent; border:none; font-size: 20px; cursor:pointer; }

  /* Countdown text */
  #countOverlay .count { font-size: clamp(64px, 12vw, 140px); font-weight: 900; text-shadow: 0 6px 0 rgba(0,0,0,.3); color:#fff; }
  #countOverlay .label { margin-top: 6px; font-size: 1.1rem; opacity: .95; color:#fff; text-align:center; }

  /* Winner modal big text */
  #winnerName { font-size: clamp(28px, 5vw, 60px); font-weight: 900; line-height:1.2; text-align:center; }
  #winnerModal .body { display:grid; gap:12px; place-items:center; }

  /* Past winners list */
  #winnersList { margin: 0; padding-left: 18px; }
</style>
</head>
<body>
  <header>
    <h1>Grand Lucky Draw</h1>
    <div class="sub">Google Sheet CSV ‚Üí Columns: <strong>Full Name</strong> and <strong>Name of Company</strong></div>
  </header>

  <div id="controls">
    <button id="btnRefresh" class="btn">üîÑ Refresh Participants</button>
    <label class="btn outline"><input type="checkbox" id="autoRefresh" style="margin-right:8px"> Auto-Refresh (10s)</label>
    <button id="btnStart" class="btn">üé¨ Start Draw</button>
    <button id="btnSound" class="btn outline" title="Use your own MP3s (assets/drum.mp3 & assets/pop.mp3)">üîä Enable Sound</button>
    <button id="btnWinners" class="btn outline">üèÜ Past Winners</button>
  </div>

  <div class="stage">
    <div class="gift" aria-label="Gift Box">
      <div class="lid-wrap">
        <div class="lid" id="lid">
          <div class="ribbon-vertical"></div>
          <div class="bow" aria-hidden="true">
            <div class="loop left"></div>
            <div class="loop right"></div>
            <div class="knot"></div>
          </div>
        </div>
      </div>
      <div class="box-base" aria-hidden="true"></div>
      <div id="entries" class="box-content">Loading participants‚Ä¶</div>
    </div>
  </div>

  <!-- Count Down Overlay -->
  <div id="countOverlay" class="overlay">
    <div style="text-align:center;">
      <div class="count" id="countText"></div>
      <div class="label" id="phaseLabel"></div>
    </div>
  </div>

  <!-- Winner Modal -->
  <div id="winnerOverlay" class="overlay">
    <div id="winnerModal" class="modal">
      <div class="head">Winner <button class="close" id="closeWinner">‚úï</button></div>
      <div class="body">
        <div id="winnerName">Winner Name</div>
        <div id="winnerCompany" style="font-size:1.1rem; opacity:.85"></div>
      </div>
    </div>
  </div>

  <!-- Past Winners Modal -->
  <div id="winnersOverlay" class="overlay">
    <div id="winnersModal" class="modal">
      <div class="head">Past Winners <button class="close" id="closeWinners">‚úï</button></div>
      <div class="body">
        <ol id="winnersList"></ol>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:8px">
          <button id="btnReset" class="btn">‚ôªÔ∏è Reset Draw</button>
          <button id="btnExportWinners" class="btn outline">‚¨áÔ∏è Download Winners CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Local audio (user-provided). Place your files at /assets/drum.mp3 and /assets/pop.mp3 -->
  <audio id="drum" preload="auto" src="drumroll.mp3"></audio>
  <audio id="pop" preload="auto" src="pop.mp3"></audio>

<script>
(function(){
  // ---- Config ----
  const DEFAULT_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9EzQVA4kCkKxyzpQ2S61wrHce8ohaH7v_QvgPzfLqNMkghG3O-_JGYQBVcUmE0-Y-vsKio3pnTeh5/pub?output=csv";
  const DRAW_COUNTDOWN_SEC = 3;
  const DRAW_PHASE_MS = 5000;
  const AUTO_REFRESH_MS = 10000;
  const BLINK_MS = 1200; // matches CSS blink duration

  // ---- State ----
  let participants = []; // ["Full Name (Company)", ...]
  let activePool = [];
  let winners = [];
  let autoTimer = null;
  let drawing = false;
  let moveTimer = null;
  let idleShuffleTimer = null;

  // ---- Elements ----
  const entriesEl = document.getElementById('entries');
  const lidEl = document.getElementById('lid');
  const countOverlay = document.getElementById('countOverlay');
  const countText = document.getElementById('countText');
  const phaseLabel = document.getElementById('phaseLabel');

  const btnRefresh = document.getElementById('btnRefresh');
  const btnStart = document.getElementById('btnStart');
  const btnReset = document.getElementById('btnReset');
  const chkAuto = document.getElementById('autoRefresh');
  const btnSound = document.getElementById('btnSound');
  const btnWinners = document.getElementById('btnWinners');
  const btnExportWinners = document.getElementById('btnExportWinners');

  const drum = document.getElementById('drum');
  const pop = document.getElementById('pop');
  drum.volume = 0.9; pop.volume = 0.7;

  // Winner modal
  const winnerOverlay = document.getElementById('winnerOverlay');
  const closeWinner = document.getElementById('closeWinner');
  const winnerNameEl = document.getElementById('winnerName');
  const winnerCompanyEl = document.getElementById('winnerCompany');

  // Past winners modal
  const winnersOverlay = document.getElementById('winnersOverlay');
  const closeWinners = document.getElementById('closeWinners');
  const winnersListEl = document.getElementById('winnersList');

  // ---- Utils ----
  function getCsvUrl(){
    const urlParam = new URLSearchParams(location.search).get('csv');
    let url = urlParam ? decodeURIComponent(urlParam) : DEFAULT_SHEET_CSV;
    const marker = 'output=csv';
    const idx = url.indexOf(marker);
    if (idx !== -1) url = url.slice(0, idx + marker.length);
    return url;
  }

  function disableControls(disabled){
    [btnStart, btnRefresh, btnReset, chkAuto, btnSound, btnWinners, btnExportWinners].forEach(el => { if (el) el.disabled = disabled; });
  }

  function renderEntries(){
    if (!activePool.length){ entriesEl.textContent = 'No participants available.'; return; }
    const html = activePool.map(p => {
      const m = p.match(/^(.*) \((.*)\)$/); // Full Name (Company)
      const name = m ? m[1] : p; const company = m ? m[2] : '';
      return `<div class="entry"><span class="name">${escapeHtml(name)}</span><span class="company">${escapeHtml(company)}</span></div>`;
    }).join('');
    entriesEl.innerHTML = html;
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // ---- CSV Fetch & Parse ----
  async function refreshParticipants(){
    try {
      const url = getCsvUrl();
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Network error: ' + res.status);
      const csvText = await res.text();
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      if (parsed.errors && parsed.errors.length){ console.warn(parsed.errors); }

      const rows = parsed.data;
      const toKey = s => String(s||'').trim().toLowerCase();
      const mapped = rows.map(r => {
        const o = {}; Object.keys(r).forEach(k => { o[toKey(k)] = r[k]; });
        const full = (o['full name'] || o['fullname'] || o['name'] || '').toString().trim();
        const comp = (o['name of company'] || o['company'] || '').toString().trim();
        return { full, comp };
      }).filter(x => x.full && x.comp);

      participants = mapped.map(x => `${x.full} (${x.comp})`);
      const seen = new Set();
      participants = participants.filter(p => (seen.has(p) ? false : (seen.add(p), true)));

      activePool = participants.filter(p => !winners.includes(p));
      renderEntries();
      startIdleShuffle();
    } catch (err){
      console.error(err);
      entriesEl.textContent = 'Unable to load participants. Ensure CSV is published and columns are correct.';
    }
  }

  // ---- Idle Shuffle on Blink ----
  function startIdleShuffle(){
    stopIdleShuffle();
    idleShuffleTimer = setInterval(()=>{
      if (drawing) return;
      if (activePool.length < 2) return;
      // Shuffle activePool lightly
      for (let i = activePool.length - 1; i > 0; i--) {
        if (Math.random() < 0.25){ // partial change so it feels organic
          const j = Math.floor(Math.random() * (i + 1));
          [activePool[i], activePool[j]] = [activePool[j], activePool[i]];
        }
      }
      renderEntries();
    }, BLINK_MS);
  }
  function stopIdleShuffle(){ if (idleShuffleTimer) { clearInterval(idleShuffleTimer); idleShuffleTimer = null; } }

  // ---- Auto refresh ----
  function toggleAuto(){
    if (chkAuto.checked){ autoTimer = setInterval(refreshParticipants, AUTO_REFRESH_MS); }
    else { clearInterval(autoTimer); autoTimer = null; }
  }

  // ---- Countdown ----
  function countdown(sec){
    countOverlay.style.display = 'grid';
    phaseLabel.textContent = 'Get Ready‚Ä¶';
    return new Promise(resolve => {
      let cur = sec; countText.textContent = cur;
      const timer = setInterval(()=>{
        cur -= 1; countText.textContent = cur > 0 ? cur : 'Go!';
        if (cur <= 0){ clearInterval(timer); setTimeout(resolve, 600); }
      }, 1000);
    });
  }

  // ---- Free movement during draw ----
  function startFreeMove(){
    stopIdleShuffle();
    entriesEl.classList.add('free');
    const items = Array.from(entriesEl.children);
    // Initial placement
    randomizePositions(items);
    moveTimer = setInterval(()=>{ randomizePositions(items); }, 380);
  }
  function randomizePositions(items){
    const b = entriesEl.getBoundingClientRect();
    items.forEach(el => {
      const r = el.getBoundingClientRect();
      const w = r.width || 190; const h = r.height || 68;
      const pad = 6;
      const maxX = Math.max(0, b.width - w - pad);
      const maxY = Math.max(0, b.height - h - pad);
      const x = Math.floor(Math.random()*maxX) + pad/2;
      const y = Math.floor(Math.random()*maxY) + pad/2;
      const rot = (Math.random()*10 - 5);
      const scale = 1 + (Math.random()*0.08);
      el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.transform = `rotate(${rot}deg) scale(${scale})`;
    });
  }
  function stopFreeMove(){
    clearInterval(moveTimer); moveTimer = null;
    entriesEl.classList.remove('free');
    Array.from(entriesEl.children).forEach(el => { el.style.left=''; el.style.top=''; el.style.transform='none'; });
    startIdleShuffle();
  }

  // ---- Draw logic ----
  async function startDraw(){
    if (drawing) return; if (!activePool.length){ alert('No participants left!'); return; }
    drawing = true; disableControls(true);

    await countdown(DRAW_COUNTDOWN_SEC);

    // Open the lid AFTER countdown
    lidEl.classList.remove('lid-fly'); void lidEl.offsetWidth; // reflow
    lidEl.classList.add('lid-fly');

    // Start drum roll (user-provided local file)
    try { drum.currentTime = 0; await drum.play(); } catch(e) { console.warn('Drum play blocked or file missing:', e); }
    phaseLabel.textContent = 'Drawing‚Ä¶'; countText.textContent = '';

    // Switch entries to free-move mode
    startFreeMove();

    await new Promise(r => setTimeout(r, DRAW_PHASE_MS));

    stopFreeMove();

    // Pick winner (unique)
    const winner = activePool[Math.floor(Math.random()*activePool.length)];
    winners.push(winner);
    activePool = activePool.filter(p => p !== winner);

    // Confetti + pop sound (user-provided local file)
    burstConfetti();
    try { pop.currentTime = 0; await pop.play(); } catch(e) { console.warn('Pop play blocked or file missing:', e); }

    // Show winner modal (stay until X is clicked)
    const m = winner.match(/^(.*) \((.*)\)$/);
    winnerNameEl.textContent = m ? m[1] : winner;
    winnerCompanyEl.textContent = m ? m[2] : '';
    winnerOverlay.style.display = 'grid';

    renderEntries();
    renderWinners();

    disableControls(false); drawing = false;
    countOverlay.style.display = 'none';
  }

  function burstConfetti(){
    const end = Date.now() + 600;
    (function frame(){
      confetti({ particleCount: 110, spread: 75, startVelocity: 58, origin: { y: 0.7 } });
      if (Date.now() < end) requestAnimationFrame(frame);
    })();
    confetti({ particleCount: 200, angle: 60, spread: 60, origin: { x: 0 }, zIndex: 200 });
    confetti({ particleCount: 200, angle: 120, spread: 60, origin: { x: 1 }, zIndex: 200 });
  }

  function renderWinners(){
    winnersListEl.innerHTML = winners.map(w => `<li>${escapeHtml(w)}</li>`).join('');
  }

  function resetDraw(){
    winners = []; activePool = participants.slice(); renderWinners(); renderEntries();
    lidEl.classList.remove('lid-fly');
  }

  async function primeAudio(){
    try {
      drum.volume = 0; await drum.play(); drum.pause(); drum.currentTime = 0; drum.volume = 0.9;
      pop.volume = 0; await pop.play(); pop.pause(); pop.currentTime = 0; pop.volume = 0.7;
      alert('Sound primed. Make sure you have assets/drum.mp3 and assets/pop.mp3 in your repository.');
    } catch(e){ alert('Your browser blocked autoplay OR MP3 files are missing. Sounds will play after interactions when available.'); }
  }

  function downloadWinnersCSV(){
    if (!winners.length){ alert('No winners yet.'); return; }
    const rows = [['Full Name', 'Name of Company']].concat(
      winners.map(w => { const m = w.match(/^(.*) \((.*)\)$/); return [m?m[1]:w, m?m[2]:'' ]; })
    );
    const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'past-winners.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // ---- Wire up ----
  btnRefresh.addEventListener('click', refreshParticipants);
  btnStart.addEventListener('click', startDraw);
  if (btnReset) btnReset.addEventListener('click', () => { resetDraw(); renderWinners(); });
  chkAuto.addEventListener('change', toggleAuto);
  btnSound.addEventListener('click', primeAudio);
  btnWinners.addEventListener('click', () => winnersOverlay.style.display = 'grid');
  closeWinners.addEventListener('click', () => winnersOverlay.style.display = 'none');
  closeWinner.addEventListener('click', () => winnerOverlay.style.display = 'none');
  btnExportWinners.addEventListener('click', downloadWinnersCSV);

  // Close modals when clicking outside
  winnersOverlay.addEventListener('click', (e)=>{ if (e.target === winnersOverlay) winnersOverlay.style.display = 'none'; });
  winnerOverlay.addEventListener('click', (e)=>{ if (e.target === winnerOverlay) winnerOverlay.style.display = 'none'; });

  // Initial load
  refreshParticipants();
})();
</script>
</body>
</html>
